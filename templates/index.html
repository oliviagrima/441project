<!DOCTYPE html>
<html>
<head>
    <title>Turret Control</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #aaa; padding: 15px; margin-bottom: 20px; }
        input { width: 300px; padding: 5px; }
        button { padding: 8px 12px; margin-top: 5px; }
        pre { background: #eee; padding: 10px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>

<h1>Turret Control</h1>

<!-- MY TURRET -->
<div class="box">
    <h2>My Turret</h2>

    <label>JSON URL:</label><br>
    <input id="myTurretUrl" type="text" placeholder="Enter turret JSON URL"><br><br>

    <label>Team ID:</label><br>
    <input id="myTeamId" type="number" placeholder="My Team #"><br><br>

    <button onclick="loadMyTurret()">Load My Turret θ</button>
    <pre id="myTurretResult">θ will appear here</pre>
</div>


<!-- TARGETS -->
<div class="box">
    <h2>Targets</h2>
    
    <label>JSON URL:</label><br>
    <input id="targetUrl" type="text" placeholder="Enter target JSON URL"><br>
    <button onclick="loadTargets()">Load Targets</button>
    
    <h3>Other Turrets</h3>
    <select id="turretSelect"></select>
    
    <h3>Globes</h3>
    <select id="globeSelect"></select>
    
    <pre id="targetResult">Target data will appear here</pre>
</div>

<!-- MOVE TURRET -->
<div class="box">
    <h2>Move Turret</h2>
    <label>Select a θ:</label><br>
    <select id="moveSelect"></select><br>
    <button onclick="moveToSelected('turretSelect')">Move to Turret</button>
    <button onclick="moveToSelected('globeSelect')">Move to Globe</button>
</div>

<script>
// ---------- MY TURRET ----------
function loadMyTurret() {
    const url = document.getElementById("myTurretUrl").value;
    const team = document.getElementById("myTeamId").value;

    if (!url || !team) return alert("Enter URL and Team ID!");

    fetch("/my_turret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: url, team: team })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);

        document.getElementById("myTurretResult").textContent =
            `θ = ${data.theta}`;
    })
    .catch(err => alert("Error: " + err));
}


// ---------- TARGETS ----------
function loadTargets() {
    const url = document.getElementById("targetUrl").value;
    fetch("/read_targets", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({url})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("targetResult").textContent =
            JSON.stringify(data, null, 2);

        if (!data.targets) return;

        const turrets = data.targets.filter(t => t.type === "turret");
        const globes = data.targets.filter(t => t.type === "globe");

        populateDropdown("turretSelect", turrets, t => `Turret ${t.id}`);
        populateDropdown("globeSelect", globes, (t, i) => `Globe ${i+1}`);
    })
    .catch(err => alert("Error loading targets: " + err));
}

// ---------- POPULATE DROPDOWN ----------
function populateDropdown(selectId, list, labelFunc) {
    const select = document.getElementById(selectId);
    select.innerHTML = ""; // Limpiar opciones anteriores

    list.forEach((item, i) => {
        const option = document.createElement("option");
        option.value = item.theta;
        option.textContent = labelFunc(item, i) + " — θ = " + item.theta;
        select.appendChild(option);
    });
}

// ---------- MOVE TO SELECTED ----------
function moveToSelected(selectId) {
    const select = document.getElementById(selectId);
    const theta = select.value;
    if (!theta) return alert("Select a θ to move to!");

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({angle: parseFloat(theta)})
    })
    .then(() => alert("Moving turret to θ = " + theta))
    .catch(err => alert("Error moving turret: " + err));
}
</script>

</body>
</html>
