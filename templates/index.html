<!DOCTYPE html>
<html>
<head>
    <title>Turret Control</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #aaa; padding: 15px; margin-bottom: 20px; }
        input { width: 300px; padding: 5px; }
        button { padding: 8px 12px; margin-top: 5px; }
        select { width: 320px; padding: 5px; margin-bottom: 5px; }
        pre { background: #eee; padding: 10px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>

<h1>Turret Control</h1>

<!-- JSON URL: -->
<div class="box">
    <h2>Set JSON URL</h2>
    <input id="jsonUrl" type="text" placeholder="Enter JSON URL"><br>
    <button onclick="setJsonUrl()">Set URL</button>
    <pre id="urlStatus">URL not set</pre>
</div>

<!-- MY TURRET: -->
<div class="box">
    <h2>My Turret</h2>
    <label>Team ID:</label><br>
    <input id="myTeamId" type="number" placeholder="My Team #"><br><br>
    <button onclick="loadMyTurret()">Load My Turret θ</button>
    <pre id="myTurretResult">θ will appear here</pre>
</div>

<div class="box">
    <h2>Manual Motor Control</h2>

    <h3>Horizontal (θ)</h3>
    <button onmousedown="startManualMove('theta', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">◀</button>
    <button onmousedown="startManualMove('theta', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▶</button>

    <h3>Vertical (z)</h3>
    <button onmousedown="startManualMove('z', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▼</button>
    <button onmousedown="startManualMove('z', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▲</button>

    <h3>Zero Control</h3>
    <button onclick="setZero()">Set Zero</button>
    <button onclick="goZero()">Move to Zero</button>
    <pre id="zeroStatus">Zero not set</pre>
</div>

<!-- TARGETS INFO: -->
<div class="box">
    <h2>Targets</h2>
    <button onclick="loadTargets()">Load Targets</button>

    <h3>Other Turrets</h3>
    <pre id="turretInfo">Turrets info will appear here</pre>

    <h3>Globes</h3>
    <pre id="globeInfo">Globes info will appear here</pre>
</div>

<!-- MOVE TURRET -->
<div class="box">
    <h2>Move Turret</h2>
    <label>Select Target:</label><br>
    <select id="moveSelect"></select><br>
    <button onclick="moveToSelected()">Move to Target</button>
</div>

<!-- LED CONTROL -->
<div class="box">
    <h2>LED Control</h2>
    <button onclick="ledOn()">Turn LED On</button>
    <button onclick="ledOff()">Turn LED Off</button>
    <pre id="ledStatus">LED is OFF</pre>
</div>

<script>
let turretJsonUrl = null;

// ---------- SET JSON URL ----------
function setJsonUrl() {
    const url = document.getElementById("jsonUrl").value;
    if (!url) return alert("Enter a URL!");
    turretJsonUrl = url;
    document.getElementById("urlStatus").textContent = "URL set: " + url;
}

// ---------- LOAD MY TURRET ----------
function loadMyTurret() {
    const team = document.getElementById("myTeamId").value;
    if (!turretJsonUrl) return alert("Set the JSON URL first!");
    if (!team) return alert("Enter your Team ID!");

    fetch("/my_turret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: turretJsonUrl, team: team })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);
        document.getElementById("myTurretResult").textContent = `θ = ${data.theta}`;
    })
    .catch(err => alert("Error: " + err));
}

// ---------- LOAD TARGETS ----------
function loadTargets() {
    if (!turretJsonUrl) return alert("Set the JSON URL first!");

    fetch("/read_targets", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ url: turretJsonUrl })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.targets) return alert("No targets found");

        const turrets = data.targets.filter(t => t.type === "turret");
        const globes = data.targets.filter(t => t.type === "globe");

        document.getElementById("turretInfo").textContent =
            turrets.map(t => `Turret ${t.id} — θ = ${t.theta.toFixed(3)}, r = ${t.r.toFixed(1)}`).join("\n");

        document.getElementById("globeInfo").textContent =
            globes.map((g, i) => `Globe ${i+1} — θ = ${g.theta.toFixed(3)}, r = ${g.r.toFixed(1)}, z = ${g.z}`).join("\n");

        populateMoveDropdown(turrets.concat(globes));
    })
    .catch(err => alert("Error loading targets: " + err));
}

// ---------- MANUAL MOTOR CONTROL ----------
let manualInterval = null;
let isManualActive = false;

function startManualMove(motor, dir) {
    if (manualInterval !== null || isManualActive) return;

    isManualActive = true;
    moveOneDegree(motor, dir);

    manualInterval = setInterval(() => {
        moveOneDegree(motor, dir);
    }, 150);
}

function stopManualMove() {
    if (manualInterval) {
        clearInterval(manualInterval);
        manualInterval = null;
    }
    isManualActive = false;
}

function moveOneDegree(motor, dir) {
    let phi = 0;
    let z = 0;

    if (motor === 'theta') phi = dir * 1;  // theta buttons now rotate laser
    if (motor === 'z') z = dir * 1;                      // z buttons move vertically

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({phi: phi, z: z})
    }).catch(err => console.log("Error moving motor:", err));
}

// ---------- ZERO CONTROL ----------
function setZero() {
    fetch("/set_zero", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
    })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        return res.json();
    })
    .then(data => alert(data.status || data.error))
    .catch(err => alert("Error setting zero: " + err));
}


function goZero() {
    fetch("/go_zero", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("zeroStatus").textContent = "Moved to zero";
        alert("Moved to zero");
    })
    .catch(err => alert("Error moving to zero: " + err));
}

// ---------- MOVE DROPDOWN ----------
function populateMoveDropdown(list) {
    const select = document.getElementById("moveSelect");
    select.innerHTML = "";
    let turretCount = 0, globeCount = 0;

    list.forEach((item) => {
        let label = item.type === "turret" ? `Turret ${++turretCount}` : `Globe ${++globeCount}`;
        const option = document.createElement("option");
        option.value = item.theta;
        option.textContent = `${label} — θ = ${item.theta.toFixed(3)}, r = ${item.r.toFixed(1)}`;
        option.dataset.r = item.r;
        if (item.type === "globe" && item.z !== undefined) option.dataset.z = item.z;
        select.appendChild(option);
    });
}

// ---------- MOVE TO SELECTED ----------
function moveToSelected() {
    const select = document.getElementById("moveSelect");
    const theta_arena = parseFloat(select.value); // target angle in arena
    if (!theta_arena) return alert("Select a target!");

    const selectedIndex = select.selectedIndex;
    let z = select.options[selectedIndex].dataset.z;
    if (z !== undefined) z = parseFloat(z);
    let r_target = parseFloat(select.options[selectedIndex].dataset.r);

    // My turret info
    const teamId = document.getElementById("myTeamId").value;
    if (!teamId) return alert("Enter your Team ID!");

    fetch("/my_turret", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({url: turretJsonUrl, team: teamId})
    })
    .then(res => res.json())
    .then(myTurret => {
        const r0 = myTurret.r;
        const theta0 = myTurret.theta;

        dist = sqrt(r_target**2 + r0**2 - 2 * r_target * r0 * math.cos(abs(thetat_arena-theta0)))

        // Law of cosines: compute phi to point at target
        const dx = r_target * Math.cos(theta_arena) - r0 * Math.cos(theta0);
        const dy = r_target * Math.sin(theta_arena) - r0 * Math.sin(theta0);
        const dx_center = -r0 * Math.cos(theta0);
        const dy_center = -r0 * Math.sin(theta0);

        let phi = Math.atan2(dy, dx) - Math.atan2(dy_center, dx_center);
        phi = phi * 180 / Math.PI;  // convert to degrees

        z0 = 0
        dz = z - z0
        z_deg = math.degrees(math.atan2(dz, dist))

        fetch("/move_motor", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({phi: phi, z: z})
        })
        .then(() => alert(`Moving turret to φ = ${phi.toFixed(2)}°, z = ${z_deg}`))
        .catch(err => alert("Error moving turret: " + err));
    })
    .catch(err => alert("Error loading my turret info: " + err));
}

function ledOn() {
    fetch("/led_on", { method: "POST" })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ledStatus").textContent = data.status;
    })
    .catch(err => alert("Error turning LED on: " + err));
}

function ledOff() {
    fetch("/led_off", { method: "POST" })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ledStatus").textContent = data.status;
    })
    .catch(err => alert("Error turning LED off: " + err));
}
    
</script>
</body>
</html>
