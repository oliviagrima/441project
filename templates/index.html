
<!DOCTYPE html>
<html>
<head>
    <title>Turret Control</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #aaa; padding: 15px; margin-bottom: 20px; }
        input { width: 300px; padding: 5px; }
        button { padding: 8px 12px; margin-top: 5px; }
        select { width: 320px; padding: 5px; margin-bottom: 5px; }
        pre { background: #eee; padding: 10px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>

<h1>Turret Control</h1>

<!-- JSON URL: set only once -->
<!-- JSON URL: -->
<div class="box">
    <h2>Set JSON URL</h2>
    <input id="jsonUrl" type="text" placeholder="Enter JSON URL"><br>
    <button onclick="setJsonUrl()">Set URL</button>
    <pre id="urlStatus">URL not set</pre>
</div>

<!-- MY TURRET: displays current turret info -->
<!-- MY TURRET: -->
<div class="box">
    <h2>My Turret</h2>
    <label>Team ID:</label><br>
    <input id="myTeamId" type="number" placeholder="My Team #"><br><br>
    <button onclick="loadMyTurret()">Load My Turret θ</button>
    <pre id="myTurretResult">θ will appear here</pre>
</div>

<div class="box">
    <h2>Manual Motor Control</h2>

    <h3>Horizontal (θ)</h3>
    <button onmousedown="startManualMove('theta', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">◀</button>
    <button onmousedown="startManualMove('theta', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▶</button>

    <h3>Vertical (z)</h3>
    <button onmousedown="startManualMove('z', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▼</button>
    <button onmousedown="startManualMove('z', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▲</button>

    <h3>Zero Control</h3>
    <button onclick="setZero()">Set Zero</button>
    <button onclick="goZero()">Move to Zero</button>
    <pre id="zeroStatus">Zero not set</pre>
</div>

<!-- TARGETS INFO: display only -->
<!-- TARGETS INFO: -->
<div class="box">
    <h2>Targets</h2>
    <button onclick="loadTargets()">Load Targets</button>

    <h3>Other Turrets</h3>
    <pre id="turretInfo">Turrets info will appear here</pre>

    <h3>Globes</h3>
    <pre id="globeInfo">Globes info will appear here</pre>
</div>

<!-- MOVE TURRET -->
<div class="box">
    <h2>Move Turret</h2>
    <label>Select Target:</label><br>
    <select id="moveSelect"></select><br>
    <button onclick="moveToSelected()">Move to Target</button>
</div>

<!-- LED CONTROL -->
<div class="box">
    <h2>LED Control</h2>
    <button onclick="ledOn()">Turn LED On</button>
    <button onclick="ledOff()">Turn LED Off</button>
    <pre id="ledStatus">LED is OFF</pre>
</div>

<script>
let turretJsonUrl = null;

// ---------- SET JSON URL ----------
function setJsonUrl() {
    const url = document.getElementById("jsonUrl").value;
    if (!url) return alert("Enter a URL!");
    turretJsonUrl = url;
    document.getElementById("urlStatus").textContent = "URL set: " + url;
}

// ---------- LOAD MY TURRET ----------
function loadMyTurret() {
    const team = document.getElementById("myTeamId").value;
    if (!turretJsonUrl) return alert("Set the JSON URL first!");
    if (!team) return alert("Enter your Team ID!");

    fetch("/my_turret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: turretJsonUrl, team: team })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);
        document.getElementById("myTurretResult").textContent = `θ = ${data.theta}`;
    })
    .catch(err => alert("Error: " + err));
}

// ---------- LOAD TARGETS ----------
function loadTargets() {
    if (!turretJsonUrl) return alert("Set the JSON URL first!");

    fetch("/read_targets", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ url: turretJsonUrl })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.targets) return alert("No targets found");

        const turrets = data.targets
            .filter(t => t.type === "turret")
            .sort((a, b) => a.id - b.id);
        const globes = data.targets
            .filter(t => t.type === "globe")
            .sort((a, b) => a.id - b.id);

        document.getElementById("turretInfo").textContent =
            turrets.map(t => `Turret ${t.id} — θ = ${t.theta.toFixed(3)}, r = ${t.r.toFixed(1)}`).join("\n");

        document.getElementById("globeInfo").textContent =
            globes.map((g, i) => `Globe ${i+1} — θ = ${g.theta.toFixed(3)}, r = ${g.r.toFixed(1)}, z = ${g.z}`).join("\n");

        populateMoveDropdown(turrets.concat(globes));
    })
    .catch(err => alert("Error loading targets: " + err));
}

// ---------- MANUAL MOTOR CONTROL ----------
let manualInterval = null;
let isManualActive = false;

function startManualMove(motor, dir) {
    if (manualInterval !== null || isManualActive) return;

    isManualActive = true;
    moveOneDegree(motor, dir);

    manualInterval = setInterval(() => {
        moveOneDegree(motor, dir);
    }, 150);
}

function stopManualMove() {
    if (manualInterval) {
        clearInterval(manualInterval);
        manualInterval = null;
    }
    isManualActive = false;
}

function moveOneDegree(motor, dir) {
    let phi = 0;
    let z = 0;

    if (motor === 'theta') phi = dir * 1;  // theta buttons now rotate laser
    if (motor === 'z') z = dir * 1;                      // z buttons move vertically

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({phi: phi, z: z})
    }).catch(err => console.log("Error moving motor:", err));
}

// ---------- ZERO CONTROL ----------
function setZero() {
    fetch("/set_zero", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
    })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        return res.json();
    })
    .then(data => alert(data.status || data.error))
    .catch(err => alert("Error setting zero: " + err));
}


function goZero() {
    fetch("/go_zero", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("zeroStatus").textContent = "Moved to zero";
        alert("Moved to zero");
    })
    .catch(err => alert("Error moving to zero: " + err));
}

// ---------- MOVE DROPDOWN ----------
function populateMoveDropdown(list) {
    const select = document.getElementById("moveSelect");
    select.innerHTML = "";

    // Separate + sort
    const turrets = list
        .filter(item => item.type === "turret")
        .sort((a, b) => a.id - b.id);

    const globes = list.filter(item => item.type === "globe");

    // ---- Turrets ----
    turrets.forEach(item => {
        const option = document.createElement("option");
        option.value = item.theta;
        option.textContent =
            `Turret ${item.id} — θ = ${item.theta.toFixed(3)}, r = ${item.r.toFixed(1)}`;
        option.dataset.r = item.r;
        select.appendChild(option);
    });

    // ---- Globes ----
    globes.forEach((item, i) => {
        const option = document.createElement("option");
        option.value = item.theta;
        option.textContent =
            `Globe ${i + 1} — θ = ${item.theta.toFixed(3)}, r = ${item.r.toFixed(1)}, z = ${item.z}`;
        option.dataset.r = item.r;
        if (item.z !== undefined) option.dataset.z = item.z;
        select.appendChild(option);
    });
}

// ---------- MOVE TO SELECTED ----------
function moveToSelected() {
    const select = document.getElementById("moveSelect");
    const selectedIndex = select.selectedIndex;
    if (selectedIndex < 0) return alert("Select a target!");

    const selectedOption = select.options[selectedIndex];

    // Determine target type
    const targetType = selectedOption.dataset.z !== undefined ? "globe" : "turret";
    const targetId = targetType === "turret" ? selectedOption.value : selectedIndex;

    // My turret info
    const teamId = document.getElementById("myTeamId").value;
    if (!teamId) return alert("Enter your Team ID!");
    if (!turretJsonUrl) return alert("Set the JSON URL first!");

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            url: turretJsonUrl,
            team: teamId,
            target_type: targetType,
            target_id: targetId
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);
        alert(`Moving turret to φ = ${data.motor1_phi_deg.toFixed(2)}°, elevation = ${data.motor2_elev_angle_deg.toFixed(2)}°`);
    })
    .catch(err => alert("Error moving turret: " + err));
}

function ledOn() {
    fetch("/led_on", { method: "POST" })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ledStatus").textContent = data.status;
    })
    .catch(err => alert("Error turning LED on: " + err));
}

function ledOff() {
    fetch("/led_off", { method: "POST" })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ledStatus").textContent = data.status;
    })
    .catch(err => alert("Error turning LED off: " + err));
}

</script>
</body>
</html>
