<!DOCTYPE html>
<html>
<head>
    <title>Turret Control</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .box { border: 1px solid #aaa; padding: 15px; margin-bottom: 20px; }
        input { width: 300px; padding: 5px; }
        button { padding: 8px 12px; margin-top: 5px; }
        select { width: 320px; padding: 5px; margin-bottom: 5px; }
        pre { background: #eee; padding: 10px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>

<h1>Turret Control</h1>

<!-- JSON URL: set only once -->
<div class="box">
    <h2>Set JSON URL</h2>
    <input id="jsonUrl" type="text" placeholder="Enter JSON URL"><br>
    <button onclick="setJsonUrl()">Set URL</button>
    <pre id="urlStatus">URL not set</pre>
</div>

<!-- MY TURRET: displays current turret info -->
<div class="box">
    <h2>My Turret</h2>
    <label>Team ID:</label><br>
    <input id="myTeamId" type="number" placeholder="My Team #"><br><br>
    <button onclick="loadMyTurret()">Load My Turret θ</button>
    <pre id="myTurretResult">θ will appear here</pre>
</div>

<div class="box">
    <h2>Manual Motor Control</h2>

    <h3>Horizontal (θ)</h3>
    <button onmousedown="startManualMove('theta', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">◀</button>
    <button onmousedown="startManualMove('theta', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▶</button>

    <h3>Vertical (z)</h3>
    <button onmousedown="startManualMove('z', -1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▼</button>
    <button onmousedown="startManualMove('z', 1)" onmouseup="stopManualMove()" onmouseleave="stopManualMove()">▲</button>
</div>

<button onclick="setZero()">Set Zero Position</button>

<script>
function setZero() {
    fetch("/set_zero", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => alert(data.status))
    .catch(err => alert("Error setting zero: " + err));
}
</script>

<div class="box">
    <h2>Return to Zero</h2>
    <button onclick="goToZero()">Go to Zero</button>
    <pre id="zeroStatus">Not moved yet</pre>
</div>
    
<!-- TARGETS INFO: display only, no selection -->
<div class="box">
    <h2>Targets</h2>
    <button onclick="loadTargets()">Load Targets</button>

    <h3>Other Turrets</h3>
    <pre id="turretInfo">Turrets info will appear here</pre>

    <h3>Globes</h3>
    <pre id="globeInfo">Globes info will appear here</pre>
</div>

<!-- MOVE TURRET: single dropdown for selecting any target -->
<div class="box">
    <h2>Move Turret</h2>
    <label>Select Target:</label><br>
    <select id="moveSelect"></select><br>
    <button onclick="moveToSelected()">Move to Target</button>
</div>

<script>
// ---------- GLOBAL URL VARIABLE ----------
let turretJsonUrl = null; // stores the JSON URL once set

// ---------- SET JSON URL ----------
function setJsonUrl() {
    const url = document.getElementById("jsonUrl").value;
    if (!url) return alert("Enter a URL!");
    turretJsonUrl = url;
    document.getElementById("urlStatus").textContent = "URL set: " + url;
}

// ---------- LOAD MY TURRET INFO ----------
function loadMyTurret() {
    const team = document.getElementById("myTeamId").value;
    if (!turretJsonUrl) return alert("Set the JSON URL first!");
    if (!team) return alert("Enter your Team ID!");

    fetch("/my_turret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: turretJsonUrl, team: team })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);
        document.getElementById("myTurretResult").textContent = `θ = ${data.theta}`;
    })
    .catch(err => alert("Error: " + err));
}

// ---------- LOAD TARGETS INFO ----------
function loadTargets() {
    if (!turretJsonUrl) return alert("Set the JSON URL first!");

    fetch("/read_targets", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ url: turretJsonUrl })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.targets) return alert("No targets found");

        // Separate turrets and globes
        const turrets = data.targets.filter(t => t.type === "turret");
        const globes = data.targets.filter(t => t.type === "globe");

        // Display info in their respective sections
        document.getElementById("turretInfo").textContent =
            turrets.map(t => `Turret ${t.id} — θ = ${t.theta.toFixed(3)}, r = ${t.r.toFixed(1)}`).join("\n");

        document.getElementById("globeInfo").textContent =
            globes.map((g, i) => `Globe ${i+1} — θ = ${g.theta.toFixed(3)}, r = ${g.r.toFixed(1)}, z = ${g.z}`).join("\n");

        // Populate move dropdown with all targets
        const moveList = turrets.concat(globes);
        populateMoveDropdown(moveList);
    })
    .catch(err => alert("Error loading targets: " + err));
}

let manualInterval = null;
let isManualActive = false;  // new flag

function startManualMove(motor, dir) {
    if (!turretJsonUrl) return;   // prevent calls if URL not set
    if (manualInterval !== null || isManualActive) return;

    isManualActive = true;
    moveOneDegree(motor, dir);  // initial step

    manualInterval = setInterval(() => {
        moveOneDegree(motor, dir);
    }, 150);
}

function stopManualMove() {
    if (manualInterval) {
        clearInterval(manualInterval);
        manualInterval = null;
    }
    isManualActive = false;
}

// move 1 degree (or more if needed)
function moveOneDegree(motor, dir) {
    let theta = 0;
    let z = 0;

    if (motor === 'theta') theta = dir * (Math.PI / 180); // convert 1 deg to rad
    if (motor === 'z') z = dir * 1; // 1 cm step; adjust to your system

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({theta: theta, z: z})
    }).catch(err => console.log("Error moving motor:", err));
}

// ---------- POPULATE MOVE DROPDOWN ----------
function populateMoveDropdown(list) {
    const select = document.getElementById("moveSelect");
    select.innerHTML = ""; // clear previous options
    
    let turretCount = 0;
    let globeCount = 0;

    list.forEach((item) => {
        let label;

        if (item.type === "turret") {
            turretCount++;
            label = `Turret ${turretCount}`;
        } else {
            globeCount++;
            label = `Globe ${globeCount}`;
        }

        const option = document.createElement("option");
        option.value = item.theta;
        option.textContent = label + " — θ = " + item.theta.toFixed(3) + ", r = " + item.r.toFixed(1);

        option.dataset.r = item.r;

        if (item.type === "globe" && item.z !== undefined) {
            option.dataset.z = item.z;
        }

        select.appendChild(option);
    });
}

// ---------- MOVE TURRET TO SELECTED TARGET ----------
function moveToSelected() {
    const select = document.getElementById("moveSelect");
    const theta = parseFloat(select.value);
    if (!theta) return alert("Select a target!");

    const selectedIndex = select.selectedIndex;
    let z = select.options[selectedIndex].dataset.z;
    if (z !== undefined) z = parseFloat(z);

    let r = select.options[selectedIndex].dataset.r;
    if (r !== undefined) r = parseFloat(r);

    fetch("/move_motor", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({theta: theta, z: z, r: r})
    })
    .then(() => alert(`Moving turret to θ = ${theta}, r = ${r}` + (z !== undefined ? `, z = ${z}` : "")))
    .catch(err => alert("Error moving turret: " + err));
}

function goToZero() {
    fetch("/go_zero", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            document.getElementById("zeroStatus").textContent = "Error: " + data.error;
            return;
        }
        document.getElementById("zeroStatus").textContent =
            `Returned to Zero\nθ₀ = ${data.theta_zero}\nz₀ = ${data.z_zero}`;
    })
    .catch(err => {
        document.getElementById("zeroStatus").textContent = "Error: " + err;
    });
}

</script>
</body>
</html>
